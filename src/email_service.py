import smtplib
import markdown
import re
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

class EmailService:
    def __init__(self, sender, password, server="smtp.gmail.com", port=587):
        self.sender = sender
        self.password = password
        self.server = server
        self.port = port
        
    def send_email(self, recipient, subject, body_markdown):
        if not self.sender or not self.password:
            return False, "Email credentials not configured"
            
        try:
            msg = MIMEMultipart('alternative')
            msg['From'] = self.sender
            msg['To'] = recipient
            msg['Subject'] = subject
            
            # Clean markdown for email body
            cleaned_markdown = re.sub(r'^```markdown\s*', '', body_markdown)
            cleaned_markdown = re.sub(r'^```\s*', '', cleaned_markdown)
            cleaned_markdown = re.sub(r'```$', '', cleaned_markdown)
            
            # Convert Markdown to HTML with TABLES extension explicitly enabled
            # This is critical for the Project Plan timeline to render correctly
            html_content = markdown.markdown(cleaned_markdown, extensions=['tables', 'fenced_code'])
            
            # Add professional styling including specific TABLE styles
            styled_html = f"""
            <html>
                <head>
                    <style>
                        body {{ font-family: Arial, sans-serif; line-height: 1.6; color: #333; }}
                        h1, h2, h3 {{ color: #2c3e50; }}
                        h1 {{ border-bottom: 2px solid #3498db; padding-bottom: 10px; }}
                        h2 {{ margin-top: 25px; color: #2c3e50; }}
                        ul {{ padding-left: 20px; }}
                        li {{ margin-bottom: 5px; }}
                        strong {{ color: #2980b9; }}
                        
                        /* TABLE STYLES FOR EMAIL CLIENTS */
                        table {{
                            width: 100%;
                            border-collapse: collapse;
                            margin: 15px 0;
                            font-size: 14px;
                        }}
                        th, td {{
                            padding: 12px;
                            border: 1px solid #ddd;
                            text-align: left;
                        }}
                        th {{
                            background-color: #f4f4f4;
                            font-weight: bold;
                            color: #2c3e50;
                        }}
                        tr:nth-child(even) {{
                            background-color: #f9f9f9;
                        }}
                        
                        .footer {{ margin-top: 30px; border-top: 1px solid #eee; padding-top: 10px; font-size: 12px; color: #7f8c8d; }}
                    </style>
                </head>
                <body>
                    {html_content}
                    <div class="footer">
                        Generated by Mira Agent
                    </div>
                </body>
            </html>
            """
            
            part1 = MIMEText(cleaned_markdown, 'plain')
            part2 = MIMEText(styled_html, 'html')
            
            msg.attach(part1)
            msg.attach(part2)
            
            with smtplib.SMTP(self.server, self.port) as server:
                server.starttls()
                server.login(self.sender, self.password)
                server.send_message(msg)
                
            return True, "Email sent successfully"
        except Exception as e:
            return False, str(e)
